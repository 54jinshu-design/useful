<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>translator</title>
    <meta name="author" content="chen">
    <meta name="description" content="final">
  </head>
  <body>
    <p>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
      <title>å…¨èƒ½ç¿»è¯‘å®˜ - ç»ˆæç‰ˆ</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <style>
        body { background: #000; color: #fff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        
        /* æ°”æ³¡è®¾è®¡ï¼šå¼ºè°ƒç‰¹å¤§å­—å· */
        .bubble { padding: 18px 24px; border-radius: 24px; max-width: 92%; position: relative; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .bubble-left { align-self: flex-start; background: #262626; border-bottom-left-radius: 4px; border-left: 6px solid #3b82f6; }
        .bubble-right { align-self: flex-end; background: #064e3b; border-bottom-right-radius: 4px; border-right: 6px solid #10b981; text-align: right; }
        
        .target-text { font-size: 28px; font-weight: 900; line-height: 1.2; margin-bottom: 8px; color: #ffffff; }
        .origin-text { font-size: 15px; opacity: 0.5; font-weight: normal; }
        
        /* æ’­æ”¾æŒ‰é’® */
        .play-btn { background: #3b82f6; color: white; padding: 10px 20px; border-radius: 14px; font-size: 16px; font-weight: bold; display: inline-block; margin-top: 12px; cursor: pointer; transition: all 0.2s; }
        .play-btn:active { transform: scale(0.95); background: #2563eb; }

        /* éº¦å…‹é£æ¿€æ´»åŠ¨ç”» */
        .active-mic { background: #ef4444 !important; animation: pulse 1s infinite; border-color: #fff !important; }
        @keyframes pulse { 0%, 100% { transform: scale(1); box-shadow: 0 0 0px rgba(239,68,68,0); } 50% { transform: scale(1.03); box-shadow: 0 0 20px rgba(239,68,68,0.4); } }

        /* æ§åˆ¶åŒºè®¾ç½® */
        select, .gender-toggle { background: #333; color: white; border-radius: 10px; padding: 8px 12px; font-size: 14px; border: 1px solid #444; }
        .gender-toggle { font-weight: bold; transition: all 0.2s; }
        .btn-me { color: #60a5fa; border-color: #3b82f6; }
        .btn-other { color: #34d399; border-color: #10b981; }
    </style> </p>
    <header class="p-4 border-b border-zinc-800 bg-zinc-900 flex flex-col gap-3">
      <div class="flex justify-between items-center">
        <h1 class="text-blue-500 font-black text-xl tracking-tight">å…¨èƒ½ç¿»è¯‘å®˜</h1>
        <button onclick="copyAll()" class="text-xs bg-zinc-700 hover:bg-zinc-600 text-white px-3 py-1.5 rounded-full transition">å¯¼
          å‡ºé€šè¯æ–‡æœ¬</button> </div>
      <div class="flex justify-between items-center bg-black/40 p-3 rounded-2xl border border-zinc-800">
        <div class="flex flex-col items-center gap-2">
          <select id="leftLang" class="w-28 font-bold text-center">
            <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
            <option value="en-US">ğŸ‡ºğŸ‡¸ è‹±è¯­</option>
            <option value="ro-RO">ğŸ‡·ğŸ‡´ ç½—è¯­</option>
          </select>
          <button id="sex-left" onclick="toggleSex('left')" class="gender-toggle btn-me">ğŸ‘¨
            æˆ‘æ–¹ (ç”·)</button> </div>
        <div class="text-zinc-600 font-bold">VS</div>
        <div class="flex flex-col items-center gap-2">
          <select id="rightLang" class="w-28 font-bold text-center">
            <option value="ro-RO" selected="selected">ğŸ‡·ğŸ‡´ ç½—è¯­</option>
            <option value="en-US">ğŸ‡ºğŸ‡¸ è‹±è¯­</option>
            <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
          </select>
          <button id="sex-right" onclick="toggleSex('right')" class="gender-toggle btn-other">ğŸ‘©
            å¯¹æ–¹ (å¥³)</button> </div>
      </div>
    </header>
    <div id="chat">
      <div class="text-center text-zinc-600 text-sm my-10 px-10"> [ä¸é—´æ–­å½•éŸ³å·²å°±ç»ª]<br>
        ç‚¹å‡»ä¸‹æ–¹éº¦å…‹é£å¼€å¯æŒç»­äº¤æµ </div>
    </div>
    <div id="preview" class="px-6 py-4 bg-zinc-900 text-blue-400 text-2xl font-black min-h-[60px] border-t border-zinc-800 italic flex items-center justify-center text-center"></div>
    <div class="p-4 bg-black pb-10 border-t border-zinc-900">
      <div class="flex gap-4 h-24">
        <div class="flex-1 flex gap-2"> <button onclick="toggleMic('left')" id="mic-left"
            class="flex-1 bg-blue-600 rounded-3xl flex flex-col items-center justify-center font-black text-lg">
            <span>ğŸ¤ æˆ‘è¯´è¯</span> </button> <button onclick="showInput('left')"
            class="w-14 bg-zinc-800 rounded-3xl text-2xl border border-zinc-700">âŒ¨ï¸</button>
        </div>
        <div class="flex-1 flex gap-2"> <button onclick="showInput('right')" class="w-14 bg-zinc-800 rounded-3xl text-2xl border border-zinc-700">âŒ¨ï¸</button>
          <button onclick="toggleMic('right')" id="mic-right" class="flex-1 bg-emerald-600 rounded-3xl flex flex-col items-center justify-center font-black text-lg">
            <span>ğŸ¤ å¯¹æ–¹è¯´</span> </button> </div>
      </div>
    </div>
    <div id="inputModal" class="fixed inset-0 bg-black/95 hidden items-center justify-center p-6 z-50">
      <div class="bg-zinc-800 w-full rounded-[40px] p-8 border border-zinc-700 shadow-2xl">
        <textarea id="manualText" class="w-full bg-black border border-zinc-700 rounded-3xl p-6 text-white text-2xl focus:outline-none focus:border-blue-500"
rows="3" placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—..."></textarea>
        <div class="flex gap-4 mt-8"> <button onclick="hideInput()" class="flex-1 py-5 bg-zinc-700 rounded-3xl text-xl font-bold">å–
            æ¶ˆ</button> <button onclick="submitManual()" class="flex-1 py-5 bg-blue-600 rounded-3xl font-black text-xl shadow-lg shadow-blue-900/40">ç¿»
            è¯‘å¹¶å‘é€</button> </div>
      </div>
    </div>
    <script>
    let recognition = null, isListening = false, currentSide = null;
    let lastProcessedText = "";
    let sexSettings = { left: 'male', right: 'female' };

    // æ€§åˆ«åˆ‡æ¢é€»è¾‘
    function toggleSex(side) {
        sexSettings[side] = (sexSettings[side] === 'male') ? 'female' : 'male';
        const btn = document.getElementById(`sex-${side}`);
        const label = (side === 'left') ? 'æˆ‘æ–¹' : 'å¯¹æ–¹';
        btn.innerText = sexSettings[side] === 'male' ? `ğŸ‘¨ ${label}(ç”·)` : `ğŸ‘© ${label}(å¥³)`;
    }

    // éº¦å…‹é£å¼€å…³
    function toggleMic(side) {
        if (isListening && currentSide === side) { stopMic(); return; }
        if (isListening) stopMic();
        startListening(side);
    }

    // æ ¸å¿ƒï¼šæŒç»­å½•éŸ³ç›‘å¬
    function startListening(side) {
        const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Speech) { alert("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå½•éŸ³ï¼Œè¯·ä½¿ç”¨Chrome/Safari"); return; }
        
        recognition = new Speech();
        recognition.lang = document.getElementById(side === 'left' ? 'leftLang' : 'rightLang').value;
        recognition.continuous = true; // å¼€å¯æŒç»­å½•éŸ³
        recognition.interimResults = true; // å¼€å¯å®æ—¶é¢„è§ˆ
        
        currentSide = side; 
        isListening = true;
        
        const btn = document.getElementById(`mic-${side}`);
        btn.classList.add('active-mic');
        btn.querySelector('span').innerText = "â¹ ç‚¹å‡»åœæ­¢";

        recognition.onresult = (e) => {
            let interim = '';
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                const text = e.results[i][0].transcript.trim();
                if (e.results[i].isFinal) {
                    // é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤è§¦å‘ç›¸åŒè¯†åˆ«å†…å®¹
                    if (text !== lastProcessedText) {
                        handleTranslate(text, side);
                        lastProcessedText = text;
                        setTimeout(() => { lastProcessedText = ""; }, 2000);
                    }
                } else {
                    interim += text;
                }
            }
            document.getElementById('preview').innerText = interim;
        };

        recognition.onerror = () => stopMic();
        recognition.onend = () => { if(isListening) recognition.start(); }; // è‡ªåŠ¨é‡å¯ä¿æŒå¸¸å¼€
        recognition.start();
    }

    function stopMic() {
        isListening = false;
        if (recognition) { recognition.onend = null; recognition.stop(); recognition = null; }
        document.querySelectorAll('[id^="mic-"]').forEach((b, i) => {
            b.classList.remove('active-mic');
            b.querySelector('span').innerText = i === 0 ? "ğŸ¤ æˆ‘è¯´è¯" : "ğŸ¤ å¯¹æ–¹è¯´";
        });
        document.getElementById('preview').innerText = "";
    }

    // ç¿»è¯‘å¤„ç†
    async function handleTranslate(text, fromSide) {
        if (!text || text.length < 1) return;
        
        const leftL = document.getElementById('leftLang').value;
        const rightL = document.getElementById('rightLang').value;
        const sl = (fromSide === 'left' ? leftL : rightL).split('-')[0];
        const tl = (fromSide === 'left' ? rightL : leftL).split('-')[0];
        
        try {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(text)}`;
            const res = await fetch(url);
            const data = await res.json();
            const result = data[0][0][0];
            
            // æ’­æŠ¥æ€§åˆ«ä¸å‘èµ·æ–¹ä¿æŒä¸€è‡´
            const voiceGender = sexSettings[fromSide];
            renderBubble(text, result, fromSide, tl, voiceGender);
        } catch (e) {
            console.error("ç¿»è¯‘å¤±è´¥", e);
        }
    }

    // æ¸²æŸ“å¤§å­—ä½“æ°”æ³¡
    function renderBubble(origin, target, side, lang, gender) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        // å³ä¾§æ˜¾ç¤ºæˆ‘å‘èµ·çš„ç¿»è¯‘ï¼Œå·¦ä¾§æ˜¾ç¤ºå¯¹æ–¹å‘èµ·çš„
        div.className = `bubble ${side === 'left' ? 'bubble-right' : 'bubble-left'}`;
        
        const safeTarget = target.replace(/'/g, "\\'").replace(/"/g, "&quot;");
        
        div.innerHTML = `
            <div class="origin-text">${origin}</div>
            <div class="target-text">${target}</div>
            <div class="play-btn" onclick="playVoice('${safeTarget}', '${lang}', '${gender}')">
                ğŸ”Š ç‚¹å‡»æ’­æŠ¥ (${gender === 'male' ? 'ç”·å£°' : 'å¥³å£°'})
            </div>
        `;
        
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
        
        // è‡ªåŠ¨ä¿å­˜å†å²è®°å½•
        const history = JSON.parse(localStorage.getItem('h_pro_final') || '[]');
        history.push({ o: origin, t: target, s: side });
        localStorage.setItem('h_pro_final', JSON.stringify(history));
    }

    // æ ¸å¿ƒæ’­æ”¾å¼•æ“ï¼šå…±æŒ¯å³°ç”·å£°å¢å¼ºç®—æ³•
    function playVoice(text, lang, gender) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        
        // æ˜ å°„è¯­è¨€ç¼–ç 
        const langMap = { 'ro': 'ro-RO', 'zh': 'zh-CN', 'en': 'en-US' };
        msg.lang = langMap[lang] || lang;

        const voices = window.speechSynthesis.getVoices();
        
        if (gender === 'male') {
            // å°è¯•å¯»æ‰¾ç³»ç»Ÿè‡ªå¸¦ç”·å£°åŒ…
            const maleVoice = voices.find(v => v.lang.startsWith(msg.lang) && 
                (v.name.toLowerCase().includes('male') || v.name.toLowerCase().includes('david') || v.name.toLowerCase().includes('kangkang')));
            if(maleVoice) msg.voice = maleVoice;
            
            msg.pitch = 0.55; // æä½éŸ³è°ƒæ¨¡æ‹Ÿç”·å£°
            msg.rate = 0.85;  // æ…¢è¯­é€Ÿå¢åŠ ç¨³é‡æ„Ÿ
        } else {
            // å¥³å£°ç‰¹å¾
            const femaleVoice = voices.find(v => v.lang.startsWith(msg.lang) && 
                (v.name.toLowerCase().includes('female') || v.name.toLowerCase().includes('google') || v.name.toLowerCase().includes('xiaoxiao')));
            if(femaleVoice) msg.voice = femaleVoice;
            
            msg.pitch = 1.35; // é«˜éŸ³è°ƒ
            msg.rate = 1.05;  // æ­£å¸¸ç•¥å¿«
        }
        
        window.speechSynthesis.speak(msg);
    }

    // æ‰‹åŠ¨æ‰“å­—æ§åˆ¶
    function showInput(side) { currentSide = side; document.getElementById('inputModal').style.display = 'flex'; document.getElementById('manualText').focus(); }
    function hideInput() { document.getElementById('inputModal').style.display = 'none'; document.getElementById('manualText').value = ""; }
    function submitManual() { 
        const t = document.getElementById('manualText').value.trim(); 
        if(t) { handleTranslate(t, currentSide); hideInput(); } 
    }

    // è®°å½•å¯¼å‡º (é˜²ä¹±ç )
    function copyAll() {
        const h = JSON.parse(localStorage.getItem('h_pro_final') || '[]');
        if(h.length === 0) return alert("æš‚æ— è®°å½•");
        const content = h.map(x => `${x.s === 'left' ? 'æˆ‘æ–¹' : 'å¯¹æ–¹'}:\nåŸæ–‡: ${x.o}\nè¯‘æ–‡: ${x.t}\n---`).join('\n\n');
        const blob = new Blob(['\ufeff' + content], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `ç¿»è¯‘å¯¹è¯è®°å½•_${new Date().getTime()}.txt`;
        a.click();
    }

    // åˆå§‹åŒ–åŠ è½½
    window.onload = () => {
        const h = JSON.parse(localStorage.getItem('h_pro_final') || '[]');
        h.forEach(x => {
            const tl = (x.s === 'left' ? document.getElementById('rightLang').value : document.getElementById('leftLang').value).split('-')[0];
            renderBubble(x.o, x.t, x.s, tl, sexSettings[x.s]);
        });
        window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
    };
</script><br>
    <p></p>
  </body>
</html>
